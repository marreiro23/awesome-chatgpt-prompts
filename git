const express = require( 'express' );
const mysql = require( 'mysql2' );
const aws = require( 'aws-sdk' );

const app = express();
const port = 3000;

// Configuração do banco de dados na AWS
const db = mysql.createConnection( {
  host: 'gpt-db01.cofjbmspgubm.us-east-1.rds.amazonaws.com',
  user: 'admin',
  password: 'Mamandic#008',
  database: 'gpt-db01'
} );

// Configuração do AWS SDK
aws.config.update( {
  accessKeyId: 'AKIAZ3F5WR4EHRLNM34G',
  secretAccessKey: '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',
  region: 'us-east-1'
} );

// Rotas da API
app.use( express.json() );

app.get( '/api/produtos', ( req, res ) =>
{
  db.query( 'SELECT * FROM produtos', ( err, results ) =>
  {
    if ( err )
    {
      res.status( 500 ).json( { error: 'Erro ao buscar produtos no banco de dados' } );
    } else
    {
      res.json( results );
    }
  } );
} );

app.post( '/api/produtos', ( req, res ) =>
{
  const { nome } = req.body;

  db.query( 'INSERT INTO produtos (nome, comprado) VALUES (?, ?)', [ nome, false ], ( err, result ) =>
  {
    if ( err )
    {
      res.status( 500 ).json( { error: 'Erro ao criar produto no banco de dados' } );
    } else
    {
      res.json( { message: 'Produto criado com sucesso' } );
    }
  } );
} );

app.put( '/api/produtos/:id', ( req, res ) =>
{
  const { id } = req.params;
  const { comprado } = req.body;

  db.query( 'UPDATE produtos SET comprado = ? WHERE id = ?', [ comprado, id ], ( err, result ) =>
  {
    if ( err )
    {
      res.status( 500 ).json( { error: 'Erro ao atualizar produto no banco de dados' } );
    } else
    {
      res.json( { message: 'Produto atualizado com sucesso' } );
    }
  } );
} );

// Inicialização do servidor
app.listen( port, () =>
{
  console.log( `Servidor rodando em http://localhost:${ port }` );
} );